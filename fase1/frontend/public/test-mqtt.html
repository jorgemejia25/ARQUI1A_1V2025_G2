<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test MQTT Connection - SIEPA</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        font-weight: bold;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
      }
      .warning {
        background-color: #fff3cd;
        color: #856404;
      }
      .info {
        background-color: #d1ecf1;
        color: #0c5460;
      }
      #console {
        background: #000;
        color: #0f0;
        padding: 15px;
        border-radius: 5px;
        height: 400px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 12px;
        margin-top: 20px;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üß™ Test de Conexi√≥n MQTT - Sistema SIEPA</h1>
      <p>
        Esta p√°gina prueba la conexi√≥n MQTT desde el navegador para diagnosticar
        problemas.
      </p>

      <div id="status" class="status warning">üîÑ Iniciando prueba...</div>

      <div>
        <button onclick="startTest()" id="startBtn">üîÑ Iniciar Prueba</button>
        <button onclick="testHistory()" id="historyBtn" disabled>
          üìà Probar Historial
        </button>
        <button onclick="clearConsole()" id="clearBtn">
          üóëÔ∏è Limpiar Consola
        </button>
      </div>

      <div id="console"></div>
    </div>

    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
    <script>
      let client = null;
      let isConnected = false;

      function log(message, type = "info") {
        const console = document.getElementById("console");
        const time = new Date().toLocaleTimeString();
        const emoji =
          type === "error"
            ? "‚ùå"
            : type === "success"
              ? "‚úÖ"
              : type === "warning"
                ? "‚ö†Ô∏è"
                : "üìù";
        console.innerHTML += `<div>[${time}] ${emoji} ${message}</div>`;
        console.scrollTop = console.scrollHeight;
      }

      function updateStatus(message, type = "info") {
        const status = document.getElementById("status");
        status.textContent = message;
        status.className = `status ${type}`;
      }

      function clearConsole() {
        document.getElementById("console").innerHTML = "";
      }

      function startTest() {
        log("üß™ INICIANDO PRUEBA DE CONEXI√ìN MQTT");
        updateStatus("üîÑ Conectando...", "warning");

        const brokerUrl = "wss://broker.hivemq.com:8884/mqtt";
        log(`üîó Conectando a: ${brokerUrl}`);

        const options = {
          clientId: `test_frontend_${Math.random().toString(16).substr(2, 8)}`,
          clean: true,
          reconnectPeriod: 5000,
          connectTimeout: 15000,
          keepalive: 60,
          protocolVersion: 4,
        };

        log(`‚öôÔ∏è ID del cliente: ${options.clientId}`);

        try {
          if (client) {
            client.end();
          }

          client = mqtt.connect(brokerUrl, options);

          client.on("connect", () => {
            log("‚úÖ ¬°CONECTADO AL BROKER MQTT!", "success");
            updateStatus("‚úÖ Conectado exitosamente", "success");
            isConnected = true;
            document.getElementById("historyBtn").disabled = false;

            // Suscribirse a t√≥picos de prueba
            const testTopics = [
              "siepa/history",
              "siepa/sensors/+",
              "siepa/test",
            ];

            testTopics.forEach((topic) => {
              client.subscribe(topic, (err) => {
                if (err) {
                  log(
                    `‚ùå Error suscribiendo a ${topic}: ${err.message}`,
                    "error"
                  );
                } else {
                  log(`üì° Suscrito exitosamente a ${topic}`, "success");
                }
              });
            });

            // Enviar mensaje de prueba
            setTimeout(() => {
              const testMsg = {
                test: true,
                timestamp: Date.now(),
                source: "test_page",
                message: "Mensaje de prueba desde la p√°gina de test",
              };

              client.publish("siepa/test", JSON.stringify(testMsg), (err) => {
                if (err) {
                  log(
                    `‚ùå Error enviando mensaje de prueba: ${err.message}`,
                    "error"
                  );
                } else {
                  log("üì§ Mensaje de prueba enviado", "success");
                }
              });
            }, 1000);
          });

          client.on("message", (topic, message) => {
            const msgStr = message.toString();
            log(
              `üì• Mensaje en ${topic}: ${msgStr.substring(0, 100)}${msgStr.length > 100 ? "..." : ""}`
            );

            if (topic === "siepa/history") {
              try {
                const data = JSON.parse(msgStr);
                log(
                  `üìà HISTORIAL RECIBIDO: ${data.total_points || 0} puntos`,
                  "success"
                );
              } catch (e) {
                log(
                  `üìà Respuesta de historial (no JSON): ${msgStr}`,
                  "warning"
                );
              }
            }
          });

          client.on("error", (error) => {
            log(`‚ùå Error MQTT: ${error.message}`, "error");
            updateStatus(`‚ùå Error: ${error.message}`, "error");
            isConnected = false;
            document.getElementById("historyBtn").disabled = true;
          });

          client.on("close", () => {
            log("üîå Conexi√≥n cerrada", "warning");
            updateStatus("üîå Conexi√≥n cerrada", "warning");
            isConnected = false;
            document.getElementById("historyBtn").disabled = true;
          });

          client.on("disconnect", () => {
            log("üì° Desconectado del broker", "warning");
            updateStatus("üì° Desconectado", "warning");
            isConnected = false;
            document.getElementById("historyBtn").disabled = true;
          });

          client.on("offline", () => {
            log("üì¥ Cliente offline", "warning");
            updateStatus("üì¥ Offline", "warning");
            isConnected = false;
            document.getElementById("historyBtn").disabled = true;
          });

          client.on("reconnect", () => {
            log("üîÑ Reintentando conexi√≥n...", "warning");
            updateStatus("üîÑ Reconectando...", "warning");
          });
        } catch (error) {
          log(`‚ùå Error creando cliente: ${error.message}`, "error");
          updateStatus(`‚ùå Error: ${error.message}`, "error");
        }
      }

      function testHistory() {
        if (!client || !isConnected) {
          log("‚ùå No conectado - no se puede probar historial", "error");
          return;
        }

        log("üîç Enviando comando de historial...");

        const historyCommand = {
          sensor_type: "all",
          max_points: 20,
          timestamp: new Date().toISOString(),
          source: "test_page",
        };

        client.publish(
          "siepa/commands/history",
          JSON.stringify(historyCommand),
          { qos: 1 },
          (err) => {
            if (err) {
              log(
                `‚ùå Error enviando comando de historial: ${err.message}`,
                "error"
              );
            } else {
              log("üì§ Comando de historial enviado exitosamente", "success");
              log("‚è∞ Esperando respuesta del backend...");
            }
          }
        );
      }

      // Auto-iniciar la prueba
      window.addEventListener("load", () => {
        setTimeout(startTest, 1000);
      });
    </script>
  </body>
</html>
